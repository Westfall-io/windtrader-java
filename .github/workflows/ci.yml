name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  build-and-smoke-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Build (Maven)
        run: mvn -q -DskipTests=true clean package

      - name: Smoke test - valid syntax should exit 0
        run: |
          echo "part Stage_1 { attribute mass; }" | java -jar target/*.jar check

      - name: Smoke test - invalid keyword should exit 2
        run: |
          set +e
          echo "part { attrib mass; }" | java -jar target/*.jar check
          code=$?
          set -e
          if [ "$code" -ne 2 ]; then
            echo "Expected exit code 2, got $code"
            exit 1
          fi

      - name: Smoke test - echo prints something
        run: |
          out="$(echo "part Stage_1 { attribute mass; }" | java -jar target/*.jar echo)"
          if [ -z "$out" ]; then
            echo "Expected non-empty echo output"
            exit 1
          fi

      - name: Upload jar artifact (CI)
        uses: actions/upload-artifact@v4
        with:
          name: windtrader-java-jar
          path: target/*.jar
